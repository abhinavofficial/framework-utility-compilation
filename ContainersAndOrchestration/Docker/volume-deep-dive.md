# Volume Deep Dive

We saw one example of volume - to mount source code in host to container. We are going to see the other use cases for volumes.

Docker volumes can be used to achieve many things, including:

* Bypassing the copy-on-write system to obtain native disk I/O performance.
* Bypassing copy-on-write to leave some files out of `docker commit`
* Sharing a directory between multiple containers
* Sharing a directory between the host and a container
* Sharing a single file between the host and a container

Volumes are special directories in a container. Volumes can be declared in two different ways.

* Within a `Dockerfile`, with a `VOLUME` instruction. `VOLUME /var/lib/postgresql`
* On the command-line, with the *-v* flag for `docker run`. `docker run -d -v /var/lib/postgresql training/postgresql`

In both case, `/var/lib/postgresql` (inside the container) will be a volume.

The main point of volumes is to create a kind of direct mapping between a directory on the host and the directory in the container. This can be used to achieve native ISO performance because then when the container is writing on the volume while reading and writing on the volume is directly reading and writing from that directory on the host without any overhead. So if you have a database and you don't want to have any I/O, extra performance cost, You can do that and that works great. You can use that to share a directory between the host and the container. And you can use that to share a directory between multiple containers. So, to see the volumes that are on your pocket hose, there is a Docker volume command. So if we do darker volume LS, we have a bunch of volumes to. So where do those volumes come from? They come the from the radius containers that I started earlier redis stole some data. So in the dockerfile of the richest container, there is an instruction to say we have a volume. So each time I create a radius container automatically volume is created and it will show up here proof If I do Docker Ram - D radius. Now Docker voluminous, I have five volumes instead of We can name volume. So if I don't want like volume like that. I can do like, Docker volume. Create that - name? Hello. And then I can do Docker Run - CI - V hello: / volume from and let's get an Alpine container. If I go in / volume, this is the hello volumes. I just created So I'm going to create a file in this volume, then I exit the container and then I start a completely different container. So let's map hello on slash whatever. And let's use a Ubuntu container and now if I look in /, whatever I have the hello, this is hello file that I created earlier. Another example. So if I take one of those volumes here, so with I said those are Regis volume. So let's see exactly what we have in them. And I'm going to map that to / what and started going to container. And now in / what Okay, that one was empty. Probably because I terminated the radius container a little bit like a Savage, but normally I should have Adam that are GB file because that's because that's a radius container. I'm going to try on that one to see what happens, but chew LS Dash L /. What All right, neither of H should at least stop one radius container correctly for that to work. Anyway. So another option with volumes is - - volumes from - - Williams. From tells to Docker. Take all the volumes of one specific container and reuse those volumes in another container. So let's see. I'm going to we're going to have a rigid container with some data in it. So let's first I'm going to stop all the containers that I have here. So I'm going to Docker, PS Dash Q. So that gives me the IDS of all those containers, pipe leaks Arts, Docker kill. So I'm just killing all the containers that are running if I do Docker PS now. Okay, everything is good. So let's start to read this container on Docker Run - - name read to 8 - D. And that's going to be using the radius image. okay, now I'm going to connect to that reduce container So Docker Run - - net container: Rich. Wait - TI Alpine sh so this is an Alpine container running in the same network, stack, as my Regice container, which means that I can connect to my Regice container by connecting on localhost Infos server. Yep, that tells me that this is Release 3.2, I'm going to do set. Place or steam get place now tells me Austin then I do. Save quit. Okay. Now, let's say that for some reason, I want that to be on radius 3.0 instead of 3.2 reminder, this is running release version 3.2 so I can do Docker run. First Docker, stop ready to wait. So I'm stopping this radius container know. I do Docker Run - - volumes From red to 8:00. There's D Dash Dash name, new radius. Radius:, 3.0, so it's downloading with this 3.0 and starting it with the same volume. Now I do Docker en dash Dash net, container coronary disease. - TI Alpine sh so I'm starting another pint container in the same network name space. What did I do wrong something darker logs new radius. I I did. Yeah. Sorry, I tried, I just tried to do a downgrade in version. I should have tried an upgraded version so I'm going to redo that I do apologize. So I'm going to wipe out right to Can you read this? Let's pretend that this didn't happen. So, Docker Run - - name read to 8. - D radius:, 2.8. All right. Now, Docker Run - TI - - net container read to eight Alpine. Sh let's connect to this radius container. Let's do info server. It will tell us that this is release. Two point eight. Indeed now I can do set Place Austin. Save, quit Docker. Stop red to eight. Sorry, I should exit the container. So Docker, stop right to 8. Now, I will start to reduce 3.0 so Docker Run - - volumes from red to 8 - name red. 3-0. - the radius: 3.0. So I'm starting a ready. 3.0 container using the same volumes as my previous radius. Now, I will connect to this radius so Docker Run - GI - - net container:. Red 3-0 Alpine SSH. Telnet localhost takes 379 in for Server tells me that I'm running radius 3.0 and It's place. Will tell me Austin. You didn't work before because most reasonable databases will let you upgrade databases and reuse your file. So if you upgrade from Regis 2.82 3.0 and then 3.1 3.2 and so on and so on each time is going to say okay so that's I see that you have read this data dump here using the old version. So I'm going to migrate to the new version. And everything is fine. However, what I did first is that I started with this 3.2 and try to downgrade and so ready. 3.0 was like what is this file here is using a version that I don't know because it was generated with registry point to so I can't read that and it refused to start. I do apologize again for the confusion. So volumes from lets us do many things like that kind of migration, but also just reuse volumes from an existing container. What happens when you remove a container that has volumes? Well, we're going to to see that if I do Docker volume. LS, I have a bunch of volumes here. I'm going to do Docker. PS Dash, q a. So that means show me all the containers that exists, the running stopped anything. And I'm going to remove all of them exhales Docker. RM Dash F. So I just wiped out all the containers from my host and now, I do Docker volume LS, all my volumes are still here. So you can you containers and the volumes are still there? There is one specific use case, which is kind of weird and also very interesting, which is to share a single file between the host and the container and the file that I want to share in my example is the docker control socket, remember. In the very beginning, I said that we communicate with the docker engine of a rest API. So there is a socket and we connect to that socket in recent comments are read. So when I say socket, maybe most of you think about the TCP socket so there is a hose. And port. And we make a TCP connection but by default Docker is using a unique socket, a unique socket. It's exactly like a TCP socket except that instead of connecting to it with an IP address and a host you connect to it with a path and it leaves on the local file system. If you look in / bar / run. You have a bunch of things including here, Docker dot sock. If you look at the file type here, there is a s like socket and so I'm going to make that socket available in a container. First, I'm going to tell you that there is a an image, a container image called Docker, so that you can have, you can run Docker in Docker. So you can do Docker, Run - TI docker Okay, so now I'm in the container and I have Docker I can do Docker version, but when I do that, it tells me cannot connect to Docker Damon because I'm inside the container. And inside that container, I Docker is not running right now. So I'm going to do Docker, Run - TI - V / VAR slash run /, Docker dot sock. Colon slash, VAR, slash log, slash dot sock. So I'm taking the docker control socket, and I'm exposing it to the same path in the container. Now, if I do Docker version, it connects to the docker server and it's a me, okay, that's fine. That's this version. If I do Docker PS, I see the containers that are running on the machine. I'm in the container, but I just gave the container. I don't know what would be the good metaphor. I gave the container a control panel to control the whole Docker instance, and I can do Something very silly. Again, Drew Docker kill D, 384. So I'm killing the container in which I'm currently located. So, when I do that, it brings me back to the docker instance. So, it seems a little bit like, oh, well, doing Locker in Docker, it's fun. Okay? This is extremely useful and Powerful. When you want to run CI, with Docker for instance, you want to use Jenkins, so that each time you push some commits, you want to run a bunch of tests on that. And that's a great idea. Idea, because you should test your code, otherwise things are going to break often, you say, okay? I won't Jenkins itself to be in a container, and I want my tests to be in a container as well. So my Jenkins container needs to stop more containers. And so very often. The first idea is, can I do Docker in Docker? And yes, you can. But no, you shouldn't because the, the real purpose of Docker in Docker. So when you really have like a Docker engine running in a container, He's chewin during the development of Docker itself because you want to have multiple versions at Bayside and whatnot. And but if you want to like have a Jenkins instance in a container and from that Jenkins, instance, start more containers, then that's the right way to do it. By mounting the socket. Lets you do that in a very clean and simple way All right, that was all about volumes and storage. So the last section will be about compose. And so this weird image is a fig because composed before being named, composed was named fig and at some point was renamed, but I kept the original illustration because I don't know exactly where they should put here to represent compose so compose. We see, It's really briefly, like for the development stack. I said compose his kind of the next level. Dockerfile is great to describe how you build a container and a compost pile is great to describe how you assemble a stack of containers and how they connect together. And to encode all the parameters. For those containers, the idea is that if you are like just like walking around on GitHub and you see it, oh, this is nice repo and oh, there is a Docker, compose file, the channel. And normally if, if the authors did the job properly, you can clone that repo and you can do Docker compose up and normally everything should be up and running and we're going to see an example of that. So out of curiosity, who's going to attend the advanced tutorial of tomorrow afternoon? That's a good bunch of people. So tomorrow we are going to have a repo here, orchestration Workshop. And in that repo there is the sample app that we're going to use, which is Docker coins. And here, there is a Docker compose, email file, and has a bunch of services. And so in this parallel universe where we, you are tasked with working on that application, all you have to do is clone the repo. So normally you are told about the address of the repo, okay? So we clone the repo, we go to this directory, there is a Docker compose, email file. We don't know exactly how the application works, what it does, and why, but we can do the compose up and then we see okay, it's pulling python. It's installing a few python stuff then it's putting Ruby because whoever wrote this decided that putting Python and Ruby together would be a good idea. Then it's Installing a bunch of packages. Okay. Then what else will it be doing? Okay, installing gems. So at that point, we kind of just take the back seat and see what's going on. The whole point is that you don't even have to follow instructions or checkered with me or install, a bunch of packages on your machine. I'm doing that on this remote virtual machine with Docker but git clone Docker compose up. You could do that on any machine anywhere on any Bistro as long as Docker is installed. Oh, there was some npm, because By phone Ruby node. Why not in there? Now, the app is up and running. If I do Docker compose PS, I see that there is a zoom, a little bit. There is a container name, the web UI and so we're going to have a look at that. It's on Port 8000. So fine. I'm going to my Docker instance on Port 8000 and I see your graph and Basically, my app is up and running. I didn't have to know anything about the app, how it works, how it? I just see these compose email file, iclone compose up compost, PS to see what is exposed. And I see a bunch of bots. I just tried to connect to them, and that's it. Of course, once you have a really big complex app with maybe, 2050, 80 containers, having a little with me, might be useful, but for many simple apps, this, this, this is really Repeat even in self-standing. All right, almost done. So Campos we have this Docker compose email. Fight to describe the stack, Installing compose fine stopping the up. Yeah, the key things to know about compose is that it's the ml, so it's pretty easy to write pretty easy to read. You have sections. Each section corresponds to one container containers. Can either use an image from the docker Hub like here, we say redis image radius, it means we want to have a service name radius and it should use the image reddest from the docker hub. And then for this service, we say that's the service name www and it will be built using a Docker file located in the directory, www And then, all those parameters here are extra parameters for Docker run like ports, that's the equivalent of - P environment. That's - e commands that switches the command to run in the container volumes. That's the equivalent of - V and so on and so on. Okay, bunch of Docker compose command, so that's pretty self-explanatory. We saw Docker compose PS. When you want to remove things. There is Docker compose, kill, Docker, compose, a ram. And also Docker compose down. So Docker compose stop and do compose kill map. Directly to Docker. Stop in Docker kill. So try to stop the containers, nicely or kill them. Immediately Docker compose are M as Might guess removes the containers and Docker compost down is a it's the whole like stop the app then remove the containers and if the application is using extra resources like custom volumes and networks, they will also be removed. There is a special handling of volumes in compose. And that's really, that's, that's super smart. Let's say that you have a radius container in your compost stack and you at some point you you have a new version of Freddy's. So you just do Docker, pull radius and that bumps up your readies version from three point two to three point three and you do Docker compose up compose will say, okay? So currently you have read is 3.2 running. But I see that you had Now read. It should be three point three. So I'm going to start a new container with version 3.3, but I'm going to take the volumes of 3.2 and move them to 3.3 basically. So it will automatically persist your data across version upgrade without you having to do anything. Right conclusion. We are like one minute before the five PM Mark. So we saw, well, we saw briefly of to install Docker. We saw how to run containers, we talked about images, we saw how to build those images manually and we Docker files. We saw networking storage. A lot of those things where we kind of quick overviews. Because as you can see, there are like tons and tons of things to seem to occur ecosystem. If you want to go, Other this is a bunch of links. So tomorrow, there is the tutorial where we see Squam and orchestration, so kind of same thing as today, but on five machines instead of one. So we're just going to be five times more complicated, and that's pretty much it. If you have questions, I will be there. Otherwise for some of you see you. Otherwise enjoy was gone. Thank you.
